<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Результаты теста</title>
</head>
<body>
    <div class="header">
        <h1>Результаты теста</h1>
        <div class="subtitle">
            {% if from_dossier %}
                {{ quiz.lesson.title }}
            {% else %}
                {{ quiz.lesson.title }}
            {% endif %}
        </div>
    </div>

    <div class="info-block">
        <div class="info-item">
            <div class="info-label">Студент</div>
            <div class="info-value">
                {% if from_dossier %}
                    {{ student.get_full_name }}
                {% else %}
                    {{ student.get_full_name }}
                {% endif %}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Курс</div>
            <div class="info-value">{{ course.title }}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Попытка</div>
            <div class="info-value">
                {% if from_dossier %}
                    #{{ attempt.attempt_number }}
                {% else %}
                    #{{ attempt.attempt_number }}
                {% endif %}
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Дата</div>
            <div class="info-value">
                {% if from_dossier %}
                    {{ attempt.completed_at|slice:":10" }}
                {% else %}
                    {{ attempt.completed_at|date:"d.m.Y H:i" }}
                {% endif %}
            </div>
        </div>
    </div>

    <div class="result-box {% if passed %}passed{% else %}failed{% endif %}">
        <div class="result-score">
            {% if from_dossier %}
                {{ attempt.score_percentage|floatformat:0 }}%
            {% else %}
                {{ attempt.score_percentage }}%
            {% endif %}
        </div>
        <div class="result-status">
            {% if passed %}
                ✓ Тест сдан
            {% else %}
                ✗ Тест не сдан (проходной балл: {{ quiz.passing_score }}%)
            {% endif %}
        </div>
        <div style="margin-top: 10px; font-size: 12px;">
            Правильных ответов: {{ correct_answers }} из {{ total_questions }}
        </div>
    </div>

    <div class="questions-section">
        <h2>Детализация ответов</h2>

        {% for response in responses %}
        <div class="question-item">
            <div class="question-header">
                <span class="question-number">Вопрос {{ forloop.counter }}</span>
                <span class="question-status {% if response.is_correct %}correct{% else %}incorrect{% endif %}">
                    {% if response.is_correct %}Верно{% else %}Неверно{% endif %}
                </span>
            </div>

            <div class="question-text">
                {% if from_dossier %}
                    {{ response.question.question_text }}
                {% else %}
                    {{ response.question.question_text }}
                {% endif %}
            </div>

            <div class="answers-list">
                {% if from_dossier %}
                    <!-- Формат из досье -->
                    <div class="answer-item">
                        <div class="answer-text selected">
                            <strong>Ответ студента:</strong>
                            {% for ans in response.user_answers %}
                                {{ ans }}{% if not forloop.last %}, {% endif %}
                            {% empty %}
                                <em>Нет ответа</em>
                            {% endfor %}
                        </div>
                    </div>
                    {% if not response.is_correct %}
                    <div class="answer-item">
                        <div class="answer-text correct">
                            <strong>Правильный ответ:</strong>
                            {% for ans in response.correct_answers %}
                                {{ ans }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                {% else %}
                    <!-- Формат из базы данных -->
                    {% for answer in response.question.answers.all %}
                    <div class="answer-item">
                        <div class="answer-marker">
                            {% if answer in response.selected_answers.all %}
                                {% if answer.is_correct %}●{% else %}✗{% endif %}
                            {% else %}
                                ○
                            {% endif %}
                        </div>
                        <div class="answer-text
                            {% if answer in response.selected_answers.all %}selected{% endif %}
                            {% if answer.is_correct %}correct{% elif answer in response.selected_answers.all %}incorrect{% endif %}">
                            {{ answer.answer_text }}
                            {% if answer.is_correct and answer not in response.selected_answers.all %}
                                <small>(правильный ответ)</small>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="footer">
        {% if from_dossier %}
            Документ сформирован из досье • {{ attempt.completed_at|slice:":10" }}
        {% else %}
            Документ сформирован автоматически • {{ attempt.completed_at|date:"d.m.Y H:i" }}
        {% endif %}
    </div>
</body>
</html>