{% extends "backoffice/base.html" %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞ - {{ attempt.quiz.lesson.title }}{% endblock %}

{% block content %}

<!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
<div class="mb-6">
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-4">
            <li>
                <a href="{% url 'backoffice:quiz_attempts_list' %}" class="text-gray-400 hover:text-gray-500">
                    –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="flex-shrink-0 h-5 w-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                    </svg>
                    <span class="ml-4 text-sm font-medium text-gray-500">{{ attempt.quiz.lesson.title }}</span>
                </div>
            </li>
        </ol>
    </nav>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã -->
    <div class="lg:col-span-2 space-y-6">
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ø—ã—Ç–∫–µ -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">{{ attempt.quiz.lesson.title }}</h2>
                
                <div class="border-t border-gray-200 pt-4">
                    <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">–°—Ç—É–¥–µ–Ω—Ç</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ attempt.user.get_full_name }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Email</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ attempt.user.email }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">–ö—É—Ä—Å</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ attempt.quiz.lesson.module.course.title }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">–ü–æ–ø—ã—Ç–∫–∞</dt>
                            <dd class="mt-1 text-sm text-gray-900">#{{ attempt.attempt_number }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">–î–∞—Ç–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ attempt.started_at|date:"d.m.Y H:i" }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">–°—Ç–∞—Ç—É—Å</dt>
                            <dd class="mt-1">
                                {% if passed %}
                                <span class="inline-flex px-2 text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                    ‚úÖ –¢–µ—Å—Ç —Å–¥–∞–Ω
                                </span>
                                {% else %}
                                <span class="inline-flex px-2 text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                    ‚ùå –¢–µ—Å—Ç –Ω–µ —Å–¥–∞–Ω
                                </span>
                                {% endif %}
                            </dd>
                        </div>
                    </dl>
                </div>
            </div>
        </div>
        
        <!-- –í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã -->
        {% for response in responses %}
        <div class="bg-white shadow rounded-lg border-l-4 {% if response.is_correct %}border-green-500{% else %}border-red-500{% endif %}">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex items-start mb-4">
                    <div class="flex-shrink-0">
                        {% if response.is_correct %}
                        <span class="text-2xl">‚úÖ</span>
                        {% else %}
                        <span class="text-2xl">‚ùå</span>
                        {% endif %}
                    </div>
                    <div class="ml-3 flex-1">
                        <h3 class="text-base font-medium text-gray-900 mb-2">
                            –í–æ–ø—Ä–æ—Å {{ forloop.counter }}: {{ response.question.question_text }}
                        </h3>
                        <p class="text-xs text-gray-500 mb-4">
                            –¢–∏–ø: {{ response.question.get_question_type_display }} | 
                            –ë–∞–ª–ª–æ–≤: {{ response.points_earned }}/{{ response.question.points }}
                        </p>
                    </div>
                </div>
                
                <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ -->
                <div class="space-y-2 ml-11">
                    {% for answer in response.question.answers.all %}
                    <div class="flex items-start p-3 rounded-md
                        {% if answer in response.selected_answers.all %}
                            {% if answer.is_correct %}
                                bg-green-50 border border-green-200
                            {% else %}
                                bg-red-50 border border-red-200
                            {% endif %}
                        {% elif answer.is_correct %}
                            bg-blue-50 border border-blue-200
                        {% else %}
                            bg-gray-50 border border-gray-200
                        {% endif %}">
                        
                        <div class="flex-shrink-0 mt-0.5">
                            {% if answer in response.selected_answers.all %}
                                {% if answer.is_correct %}
                                <span class="text-green-600">‚úÖ</span>
                                {% else %}
                                <span class="text-red-600">‚ùå</span>
                                {% endif %}
                            {% elif answer.is_correct %}
                                <span class="text-blue-600">üí°</span>
                            {% else %}
                                <span class="text-gray-400">‚óã</span>
                            {% endif %}
                        </div>
                        
                        <div class="ml-3 flex-1">
                            <p class="text-sm {% if answer in response.selected_answers.all %}font-medium{% endif %}
                                {% if answer.is_correct %}text-green-900
                                {% elif answer in response.selected_answers.all %}text-red-900
                                {% else %}text-gray-700{% endif %}">
                                {{ answer.answer_text }}
                            </p>
                            
                            {% if answer in response.selected_answers.all and not answer.is_correct %}
                            <p class="text-xs text-red-600 mt-1">–í—ã–±—Ä–∞–Ω —Å—Ç—É–¥–µ–Ω—Ç–æ–º (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)</p>
                            {% elif answer in response.selected_answers.all and answer.is_correct %}
                            <p class="text-xs text-green-600 mt-1">–í—ã–±—Ä–∞–Ω —Å—Ç—É–¥–µ–Ω—Ç–æ–º (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)</p>
                            {% elif answer.is_correct %}
                            <p class="text-xs text-blue-600 mt-1">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- –ü–æ—è—Å–Ω–µ–Ω–∏–µ -->
                {% if response.question.explanation %}
                <div class="mt-4 ml-11 p-3 bg-blue-50 border border-blue-200 rounded-md">
                    <p class="text-xs font-medium text-blue-900 mb-1">üí° –ü–æ—è—Å–Ω–µ–Ω–∏–µ:</p>
                    <p class="text-sm text-blue-800">{{ response.question.explanation }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        
    </div>
    
    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –°–≤–æ–¥–∫–∞ -->
    <div class="space-y-6">
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
        <div class="bg-white shadow rounded-lg {% if passed %}border-l-4 border-green-500{% else %}border-l-4 border-red-500{% endif %}">
            <div class="px-4 py-5 sm:p-6">
                {% if passed %}
                <h3 class="text-base font-medium text-green-900 mb-2">‚úÖ –¢–µ—Å—Ç —Å–¥–∞–Ω!</h3>
                {% else %}
                <h3 class="text-base font-medium text-red-900 mb-2">‚ùå –¢–µ—Å—Ç –Ω–µ —Å–¥–∞–Ω</h3>
                {% endif %}
                
                <div class="mt-4 space-y-3">
                    <div>
                        <p class="text-sm text-gray-500">–†–µ–∑—É–ª—å—Ç–∞—Ç</p>
                        <p class="text-2xl font-bold {% if passed %}text-green-600{% else %}text-red-600{% endif %}">
                            {{ attempt.score_percentage }}%
                        </p>
                    </div>
                    
                    <div class="pt-3 border-t border-gray-200">
                        <p class="text-sm text-gray-500">–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª</p>
                        <p class="text-lg font-medium text-gray-900">{{ attempt.quiz.passing_score }}%</p>
                    </div>
                    
                    <div class="pt-3 border-t border-gray-200">
                        <p class="text-sm text-gray-500">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</p>
                        <p class="text-lg font-medium text-gray-900">
                            {{ responses|length|add:"0" }}
                            {% with correct_count=0 %}
                                {% for r in responses %}
                                    {% if r.is_correct %}
                                        {% with correct_count=correct_count|add:1 %}{% endwith %}
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                            / {{ responses|length }}
                        </p>
                    </div>
                    
                    {% if attempt.completed_at %}
                    <div class="pt-3 border-t border-gray-200">
                        <p class="text-sm text-gray-500">–í—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è</p>
                        <p class="text-sm text-gray-900">
                            {% widthratio attempt.get_duration_seconds 60 1 %} –º–∏–Ω.
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-base font-medium text-gray-900 mb-4">–î–µ–π—Å—Ç–≤–∏—è</h3>

                <div class="space-y-3">
                    {% if attempt.status == 'completed' or attempt.status == 'timeout' %}
                    <a href="{% url 'backoffice:export_quiz_attempt_pdf' attempt.id %}"
                       class="block w-full text-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        üìÑ –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ PDF
                    </a>
                    {% endif %}

                    {% if enrollment and enrollment.group %}
                    <a href="{% url 'backoffice:student_progress' attempt.user.id enrollment.group.id %}"
                       class="block w-full text-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        üìä –í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å —Å—Ç—É–¥–µ–Ω—Ç–∞
                    </a>
                    {% endif %}

                    <a href="{% url 'backoffice:quiz_attempts_list' %}"
                       class="block w-full text-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
                    </a>
                </div>
            </div>
        </div>
    </div>
    
</div>

{% endblock %}
