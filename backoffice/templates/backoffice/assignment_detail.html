{% extends 'backoffice/base.html' %}

{% block title %}{{ submission.assignment.lesson.title }} - –ü—Ä–æ–≤–µ—Ä–∫–∞ –î–ó{% endblock %}

{% block content %}

<!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
<div class="mb-6">
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-4">
            <li>
                <a href="{% url 'backoffice:assignments_check' %}" class="text-gray-400 hover:text-gray-500">
                    –ü—Ä–æ–≤–µ—Ä–∫–∞ –î–ó
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="flex-shrink-0 h-5 w-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                    </svg>
                    <span class="ml-4 text-sm font-medium text-gray-500">{{ submission.assignment.lesson.title }}</span>
                </div>
            </li>
        </ol>
    </nav>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –†–∞–±–æ—Ç–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞ -->
    <div class="lg:col-span-2 space-y-6">
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–±–æ—Ç–µ -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">{{ submission.assignment.lesson.title }}</h2>
                
                <div class="border-t border-gray-200 pt-4">
                    <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">–°—Ç—É–¥–µ–Ω—Ç</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ submission.user.get_full_name }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Email</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ submission.user.email }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">–ö—É—Ä—Å</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ submission.assignment.lesson.module.course.title }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">–ü–æ–ø—ã—Ç–∫–∞</dt>
                            <dd class="mt-1 text-sm text-gray-900">‚Ññ{{ submission.submission_number }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">–î–∞—Ç–∞ —Å–¥–∞—á–∏</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ submission.submitted_at|date:"d.m.Y H:i" }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">–°—Ç–∞—Ç—É—Å</dt>
                            <dd class="mt-1">
                                <span class="inline-flex px-2 text-xs leading-5 font-semibold rounded-full
                                   {% if submission.status == 'in_review' %}bg-yellow-100 text-yellow-800
                                   {% elif submission.status == 'needs_revision' %}bg-orange-100 text-orange-800
                                   {% elif submission.status == 'passed' %}bg-green-100 text-green-800
                                   {% elif submission.status == 'failed' %}bg-red-100 text-red-800
                                   {% endif %}">
                                    {{ submission.get_status_display }}
                                </span>
                            </dd>
                        </div>
                    </dl>
                </div>
            </div>
        </div>
        
        <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∫ –∑–∞–¥–∞–Ω–∏—é -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-base font-medium text-gray-900 mb-3">–ó–∞–¥–∞–Ω–∏–µ</h3>
                <div class="text-sm text-gray-700 whitespace-pre-line">{{ submission.assignment.instructions }}</div>
            </div>
        </div>
        
        <!-- –û—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞ -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-base font-medium text-gray-900 mb-3">–û—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞</h3>

                {% if submission.submission_text %}
                <div class="text-sm text-gray-700 whitespace-pre-line mb-4">{{ submission.submission_text }}</div>
                {% endif %}

                {% if submission.submission_file %}
                <div class="mt-4">
                    <a href="{{ submission.submission_file.url }}" target="_blank"
                       class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        üìé –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                    </a>
                </div>
                {% endif %}

                {% if not submission.submission_text and not submission.submission_file %}
                <p class="text-sm text-gray-500">–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞</p>
                {% endif %}
            </div>
        </div>


    {% if submission.feedback %}
    <div class="bg-white shadow rounded-lg border-l-4
        {% if submission.status == 'passed' %}border-green-500 bg-green-50
        {% elif submission.status == 'needs_revision' %}border-orange-500 bg-orange-50
        {% elif submission.status == 'failed' %}border-red-500 bg-red-50
        {% endif %}">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    {% if submission.status == 'passed' %}
                    <span class="text-3xl">‚úÖ</span>
                    {% elif submission.status == 'needs_revision' %}
                    <span class="text-3xl">‚úèÔ∏è</span>
                    {% elif submission.status == 'failed' %}
                    <span class="text-3xl">‚ùå</span>
                    {% endif %}
                </div>
                <div class="ml-4 flex-1">
                    <h3 class="text-base font-medium
                        {% if submission.status == 'passed' %}text-green-900
                        {% elif submission.status == 'needs_revision' %}text-orange-900
                        {% elif submission.status == 'failed' %}text-red-900
                        {% endif %} mb-2">
                        –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
                    </h3>

                    {% if submission.status == 'passed' %}
                    <p class="text-sm font-medium text-green-800 mb-2">
                        –†–∞–±–æ—Ç–∞ –∑–∞—á—Ç–µ–Ω–∞! –ë–∞–ª–ª: {{ submission.score }}/{{ submission.assignment.max_score }}
                    </p>
                    {% elif submission.status == 'needs_revision' %}
                    <p class="text-sm font-medium text-orange-800 mb-2">
                        –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞
                    </p>
                    {% elif submission.status == 'failed' %}
                    <p class="text-sm font-medium text-red-800 mb-2">
                        –†–∞–±–æ—Ç–∞ –Ω–µ –∑–∞—á—Ç–µ–Ω–∞. –ë–∞–ª–ª: {{ submission.score }}/{{ submission.assignment.max_score }}
                    </p>
                    {% endif %}

                    <div class="text-sm
                        {% if submission.status == 'passed' %}text-green-700
                        {% elif submission.status == 'needs_revision' %}text-orange-700
                        {% elif submission.status == 'failed' %}text-red-700
                        {% endif %} whitespace-pre-line">{{ submission.feedback }}</div>

                    <div class="mt-3 text-xs
                        {% if submission.status == 'passed' %}text-green-600
                        {% elif submission.status == 'needs_revision' %}text-orange-600
                        {% elif submission.status == 'failed' %}text-red-600
                        {% endif %}">
                        <p>–ü—Ä–æ–≤–µ—Ä–∏–ª: {{ submission.reviewed_by.get_full_name }}</p>
                        <p>–î–∞—Ç–∞: {{ submission.reviewed_at|date:"d.m.Y H:i" }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
        
        <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-base font-medium text-gray-900 mb-4">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
                
                <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
                <div class="space-y-4 mb-6">
                    {% for comment in comments %}
                    <div class="border-l-4 {% if comment.is_instructor %}border-indigo-400 bg-indigo-50{% else %}border-gray-300 bg-gray-50{% endif %} p-4">
                        <div class="flex items-start">
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-900">
                                    {{ comment.author.get_full_name }}
                                    {% if comment.is_instructor %}
                                    <span class="text-xs text-indigo-600">(–ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä)</span>
                                    {% endif %}
                                </p>
                                <p class="mt-1 text-sm text-gray-700 whitespace-pre-line">{{ comment.message }}</p>
                                <p class="mt-2 text-xs text-gray-500">{{ comment.created_at|date:"d.m.Y H:i" }}</p>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-sm text-gray-500">–ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>
                    {% endfor %}
                </div>
                
                <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                <form method="post" class="mt-6">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_comment">
                    <div>
                        <label for="message" class="block text-sm font-medium text-gray-700 mb-2">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                        <textarea name="message" id="message" rows="3" 
                                  class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md" 
                                  placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
                    </div>
                    <div class="mt-3">
                        <button type="submit" 
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                            –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
    </div>
    
    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –î–µ–π—Å—Ç–≤–∏—è -->
    <div class="space-y-6">
        
        {% if submission.status == 'in_review' or submission.status == 'needs_revision' %}
        <!-- –ó–∞—á–µ—Å—Ç—å -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-base font-medium text-gray-900 mb-4">‚úÖ –ó–∞—á–µ—Å—Ç—å —Ä–∞–±–æ—Ç—É</h3>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="pass">
                    
                    <div class="mb-4">
                        <label for="score" class="block text-sm font-medium text-gray-700 mb-2">
                            –ë–∞–ª–ª (–º–∞–∫—Å: {{ submission.assignment.max_score }})
                        </label>
                        <input type="number" name="score" id="score" min="0" max="{{ submission.assignment.max_score }}" 
                               class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md" 
                               required>
                    </div>
                    
                    <div class="mb-4">
                        <label for="feedback_pass" class="block text-sm font-medium text-gray-700 mb-2">
                            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                        </label>
                        <textarea name="feedback" id="feedback_pass" rows="3" 
                                  class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md" 
                                  placeholder="–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!"></textarea>
                    </div>
                    
                    <button type="submit" 
                            class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
                        –ó–∞—á–µ—Å—Ç—å
                    </button>
                </form>
            </div>
        </div>
        
        <!-- –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-base font-medium text-gray-900 mb-4">‚úèÔ∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞</h3>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="needs_revision">
                    
                    <div class="mb-4">
                        <label for="feedback_revision" class="block text-sm font-medium text-gray-700 mb-2">
                            –ß—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å *
                        </label>
                        <textarea name="feedback" id="feedback_revision" rows="4" 
                                  class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md" 
                                  placeholder="–£–∫–∞–∂–∏—Ç–µ —á—Ç–æ –Ω—É–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å..." required></textarea>
                    </div>
                    
                    <button type="submit" 
                            class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-orange-600 hover:bg-orange-700">
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
        
        {% if submission.status == 'passed' %}
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <h3 class="text-base font-medium text-green-900 mb-2">‚úÖ –†–∞–±–æ—Ç–∞ –∑–∞—á—Ç–µ–Ω–∞</h3>
            <p class="text-sm text-green-700 mb-2">–ë–∞–ª–ª: {{ submission.score }}/{{ submission.assignment.max_score }}</p>
            <p class="text-xs text-green-600">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ –≤—ã—à–µ</p>
        </div>
        {% endif %}

        {% if submission.status == 'needs_revision' %}
        <!-- –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞ -->
        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
            <h3 class="text-base font-medium text-orange-900 mb-2">‚úèÔ∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞</h3>
            <p class="text-xs text-orange-600">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ –≤—ã—à–µ</p>
        </div>
        {% endif %}

        {% if submission.status == 'failed' %}
        <!-- –ù–µ –∑–∞—á—Ç–µ–Ω–æ -->
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <h3 class="text-base font-medium text-red-900 mb-2">‚ùå –†–∞–±–æ—Ç–∞ –Ω–µ –∑–∞—á—Ç–µ–Ω–∞</h3>
            <p class="text-sm text-red-700 mb-2">–ë–∞–ª–ª: {{ submission.score }}/{{ submission.assignment.max_score }}</p>
            <p class="text-xs text-red-600">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ –≤—ã—à–µ</p>
        </div>
        {% endif %}
        
    </div>
    
</div>

{% endblock %}