{% extends "backoffice/base.html" %}

{% block title %}–î–æ—Å—å–µ: {{ dossier.get_full_name }} - Backoffice{% endblock %}

{% block content %}

<!-- –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ -->
<div class="mb-6">
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-4">
            <li>
                <a href="{% url 'backoffice:student_dossiers_list' %}" class="text-gray-400 hover:text-gray-500">–î–æ—Å—å–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</a>
            </li>
            <li>
                <div class="flex items-center">
                    <svg class="flex-shrink-0 h-5 w-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                    </svg>
                    <span class="ml-4 text-sm font-medium text-gray-500">{{ dossier.get_full_name }}</span>
                </div>
            </li>
        </ol>
    </nav>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="lg:col-span-2 space-y-6">
        
        <!-- –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">üë§ –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
                
                <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–§–ò–û</dt>
                        <dd class="mt-1 text-sm text-gray-900 font-medium">{{ dossier.get_full_name }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–ò–ò–ù</dt>
                        <dd class="mt-1 text-sm text-gray-900 font-mono">{{ dossier.iin }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Email</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ dossier.email }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–¢–µ–ª–µ—Ñ–æ–Ω</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ dossier.phone|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</dd>
                    </div>
                </dl>
                
                {% if not dossier.user %}
                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                    <p class="text-sm text-yellow-800">‚ö†Ô∏è –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª–µ–Ω. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –¥–æ—Å—å–µ.</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- –û–±—É—á–µ–Ω–∏–µ -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">üìö –û–±—É—á–µ–Ω–∏–µ</h2>
                
                <dl class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–ö—É—Ä—Å</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ dossier.course_title }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–ì—Ä—É–ø–ø–∞</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ dossier.group_name }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ dossier.instructor_name|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–î–Ω–µ–π –Ω–∞ –æ–±—É—á–µ–Ω–∏–µ</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ dossier.total_study_days }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–î–∞—Ç–∞ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ dossier.enrolled_at|date:"d.m.Y H:i" }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ dossier.completed_at|date:"d.m.Y H:i" }}</dd>
                    </div>
                </dl>
            </div>
        </div>
        
        <!-- –ò—Å—Ç–æ—Ä–∏—è –º–æ–¥—É–ª–µ–π -->
        {% if dossier.modules_history %}
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">üì¶ –ú–æ–¥—É–ª–∏</h2>
                
                <div class="space-y-3">
                    {% for module in dossier.modules_history %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <p class="text-sm font-medium text-gray-900">{{ module.module_title }}</p>
                            <p class="text-xs text-gray-500">–£—Ä–æ–∫–æ–≤: {{ module.completed_lessons }}/{{ module.total_lessons }}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-xs text-gray-500">{{ module.completed_at|slice:":10" }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- –ò—Å—Ç–æ—Ä–∏—è —É—Ä–æ–∫–æ–≤ -->
        {% if dossier.lessons_history %}
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">üìñ –£—Ä–æ–∫–∏ ({{ dossier.lessons_history|length }})</h2>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">–ú–æ–¥—É–ª—å</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">–£—Ä–æ–∫</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500">–¢–∏–ø</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500">–ó–∞–≤–µ—Ä—à–µ–Ω</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% for lesson in dossier.lessons_history %}
                            <tr>
                                <td class="px-4 py-2 text-sm text-gray-500">{{ lesson.module_title }}</td>
                                <td class="px-4 py-2 text-sm text-gray-900">{{ lesson.lesson_title }}</td>
                                <td class="px-4 py-2 text-center">
                                    {% if lesson.lesson_type == 'video' %}üìπ
                                    {% elif lesson.lesson_type == 'text' %}üìÑ
                                    {% elif lesson.lesson_type == 'quiz' %}‚ùì
                                    {% elif lesson.lesson_type == 'assignment' %}üìù
                                    {% else %}üìö{% endif %}
                                </td>
                                <td class="px-4 py-2 text-xs text-gray-500 text-center">{{ lesson.completed_at|slice:":10" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
        
         <!-- –ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤ -->
        {% if dossier.quizzes_history %}
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">üéØ –°–¥–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã ({{ dossier.quizzes_history|length }})</h2>
                {% for quiz in dossier.quizzes_history %}
                <div class="mb-6 border border-gray-200 rounded-lg overflow-hidden">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–µ—Å—Ç–∞ —Å –º–∞—Ä–∫–µ—Ä–æ–º -->
                    <div class="px-4 py-3 bg-gray-50 flex items-center justify-between"
                        <div>
                            <p class="font-medium text-gray-900">
                                {{ quiz.lesson_title }}
                                {% if quiz.is_final_exam %}
                                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">üéì –ò—Ç–æ–≥–æ–≤—ã–π</span>
                                {% endif %}
                            </p>
                            <p class="text-xs text-gray-500">–°–¥–∞–Ω —Å {{ quiz.attempt_number }}-–π –ø–æ–ø—ã—Ç–∫–∏ | {{ quiz.completed_at|slice:":10" }}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="text-right">
                                <span class="text-lg font-bold {% if quiz.passed %}text-green-600{% else %}text-red-600{% endif %}">
                                    {{ quiz.score_percentage|floatformat:0 }}%
                                </span>
                                <p class="text-xs text-gray-500">–ü—Ä–æ—Ö–æ–¥–Ω–æ–π: {{ quiz.passing_score }}%</p>
                            </div>
                            <a target="_blank" href="{% url 'backoffice:export_dossier_quiz_pdf' dossier.id forloop.counter0 %}"
                               class="inline-flex items-center px-3 py-1 border border-gray-300 shadow-sm text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
                               title="–°–∫–∞—á–∞—Ç—å PDF">
                                üìÑ –°–∫–∞—á–∞—Ç—å PDF
                            </a>
                        </div>
                    </div>

                    <!-- –í–æ–ø—Ä–æ—Å—ã -->
                    <div class="p-4">
                        <p class="text-sm font-medium text-gray-700 mb-3">–í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã:</p>
                        {% for q in quiz.questions %}
                        <div class="mb-3 p-3 rounded-lg {% if q.is_correct %}bg-green-50 border-l-4 border-green-500{% else %}bg-red-50 border-l-4 border-red-500{% endif %}">
                            <p class="text-sm font-medium text-gray-900 mb-2">{{ q.question_text }}</p>
                            <div class="text-xs">
                                <p class="text-gray-600">
                                    <span class="font-medium">–û—Ç–≤–µ—Ç:</span>
                                    {% for ans in q.user_answers %}{{ ans }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                </p>
                                {% if not q.is_correct %}
                                <p class="text-green-700 mt-1">
                                    <span class="font-medium">–ü—Ä–∞–≤–∏–ª—å–Ω–æ:</span>
                                    {% for ans in q.correct_answers %}{{ ans }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                </p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- –ò—Å—Ç–æ—Ä–∏—è –î–ó -->
        {% if dossier.assignments_history %}
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4">üìù –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è ({{ dossier.assignments_history|length }})</h2>
                
                {% for assignment in dossier.assignments_history %}
                <div class="mb-4 border border-gray-200 rounded-lg overflow-hidden">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –î–ó -->
                    <div class="px-4 py-3 bg-gray-50 flex items-center justify-between">
                        <div>
                            <p class="font-medium text-gray-900">{{ assignment.lesson_title }}</p>
                            <p class="text-xs text-gray-500">
                                –ü–æ–ø—ã—Ç–∫–∞ #{{ assignment.submission_number }} | 
                                –°–¥–∞–Ω–æ: {{ assignment.submitted_at|slice:":10" }}
                            </p>
                        </div>
                        <div class="text-right">
                            {% if assignment.status == 'passed' %}
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                ‚úÖ –ó–∞—á—Ç–µ–Ω–æ
                            </span>
                            {% elif assignment.status == 'needs_revision' %}
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-orange-100 text-orange-800">
                                ‚úèÔ∏è –î–æ—Ä–∞–±–æ—Ç–∫–∞
                            </span>
                            {% else %}
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                                {{ assignment.status }}
                            </span>
                            {% endif %}
                            <p class="text-sm font-bold mt-1">{{ assignment.score }}/{{ assignment.max_score }}</p>
                        </div>
                    </div>
                    
                    <!-- –î–µ—Ç–∞–ª–∏ -->
                    <div class="p-4 space-y-3">
                        <!-- –û—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞ -->
                        {% if assignment.student_answer %}
                        <div>
                            <p class="text-xs font-medium text-gray-500 mb-1">–û—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞:</p>
                            <p class="text-sm text-gray-700 bg-gray-50 p-2 rounded whitespace-pre-line">{{ assignment.student_answer|truncatewords:100 }}</p>
                        </div>
                        {% endif %}
                        
                        {% if assignment.student_file %}
                        <p class="text-xs text-gray-500">üìé –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω —Ñ–∞–π–ª</p>
                        {% endif %}
                        
                        <!-- Feedback –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è -->
                        {% if assignment.instructor_feedback %}
                        <div class="border-t pt-3">
                            <p class="text-xs font-medium text-gray-500 mb-1">–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –æ—Ç {{ assignment.reviewer_name|default:'–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è' }}:</p>
                            <p class="text-sm text-gray-700 bg-blue-50 p-2 rounded whitespace-pre-line">{{ assignment.instructor_feedback }}</p>
                            <p class="text-xs text-gray-400 mt-1">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: {{ assignment.reviewed_at|slice:":10" }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
    </div>
    
    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="space-y-6">
        
        <!-- –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç -->
        <div class="bg-white shadow rounded-lg border-l-4 border-green-500">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">üìú –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</h3>
                
                <div class="space-y-3">
                    <div>
                        <p class="text-sm text-gray-500">–ù–æ–º–µ—Ä</p>
                        <p class="text-lg font-mono font-bold text-gray-900">{{ dossier.certificate_number }}</p>
                    </div>
                    
                    <div>
                        <p class="text-sm text-gray-500">–î–∞—Ç–∞ –≤—ã–ø—É—Å–∫–∞</p>
                        <p class="text-sm text-gray-900">{{ dossier.graduated_at|date:"d.m.Y H:i" }}</p>
                    </div>

                    <div class="flex flex-wrap gap-3">
                        <a target="_blank" href="{% url 'backoffice:export_dossier_certificate_no_stamp' dossier.id %}"
                           class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                            üìÑ –°–∫–∞—á–∞—Ç—å –±–µ–∑ –ø–µ—á–∞—Ç–∏
                        </a>

                        <a target="_blank" href="{% url 'backoffice:export_dossier_certificate_with_stamp' dossier.id %}"
                           class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                            üéì –°–∫–∞—á–∞—Ç—å —Å –ø–µ—á–∞—Ç—å—é
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
                
                <div class="space-y-4">
                    <div class="text-center p-4 bg-indigo-50 rounded-lg">
                        <p class="text-sm text-indigo-600">–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞</p>
                        <p class="text-4xl font-bold text-indigo-700">{{ dossier.final_score|floatformat:0 }}%</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-500">–£—Ä–æ–∫–æ–≤</p>
                            <p class="text-xl font-bold text-gray-900">{{ dossier.total_lessons_completed }}</p>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-500">–°—Ä. –±–∞–ª–ª —Ç–µ—Å—Ç–æ–≤</p>
                            <p class="text-xl font-bold text-gray-900">{{ dossier.average_quiz_score|floatformat:0 }}%</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –î–µ–π—Å—Ç–≤–∏—è —Å –¥–æ—Å—å–µ -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-base font-medium text-gray-900 mb-4">–î–µ–π—Å—Ç–≤–∏—è</h3>



            </div>
        </div>
        
        <!-- –ú–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-sm font-medium text-gray-500 mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—å–µ</h3>
                
                <div class="space-y-2 text-xs text-gray-500">
                    <p>ID –¥–æ—Å—å–µ: {{ dossier.id }}</p>
                    <p>–°–æ–∑–¥–∞–Ω–æ: {{ dossier.dossier_created_at|date:"d.m.Y H:i" }}</p>
                    {% if dossier.user %}
                    <p>User ID: {{ dossier.user.id }}</p>
                    {% else %}
                    <p class="text-yellow-600">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- –ù–∞–∑–∞–¥ -->
        <a href="{% url 'backoffice:student_dossiers_list' %}" class="block w-full text-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
        </a>
        
    </div>
    
</div>

{% endblock %}
